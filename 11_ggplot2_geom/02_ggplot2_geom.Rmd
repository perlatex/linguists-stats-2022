---
title: "ggplot2之几何形状"
author: "王小二"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: flatly
    highlight: pygments
    code_download: true
    toc: true
    toc_float: true
    number_sections: true
    df_print: paged
---


> 用 ggplot2 画图，有种恋爱的感觉: "你懂我的图谋不轨，我懂你的故作矜持"。


请大家提前安装好以下宏包
```{r, eval=FALSE}
install.packages( 
 c("ggridges", "see", "palmerpenguins", "datapasta", "colorspace", "sf",
   "cowplot",  "gganimate", "ggrepel", "ggforce", "janitor", "patchwork", 
   "readxl",  "showtext", "styler", "remotes", "rnaturalearth", "geomtextpath") 
)
```


# 数据类型

```{block}
R语言数据类型：有字符串型、数值型、因子型、逻辑型、日期型等。

ggplot2的视角：**离散变量**、**连续变量**、**日期变量**。


**离散变量**: 字符串型<chr>, 因子型<fct>, 逻辑型<lgl>

**连续变量**: 双精度数值<dbl>, 整数数值<int>

**日期变量**: 日期<date>, 时间<time>, 日期时间<dttm>
```



我们在ggplot2绘图的时候，可能会同时用到多种类型的变量，比如

* 一个离散
* 一个连续

* 两个离散
* 两个连续
* 一个离散, 一个连续

* 三个连续



```{block}
接下来，我们需要围绕不同数据类型，思考应该选择什么样的形状，回答数据问题。
```



# 开始

还是用企鹅数据

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
penguins <- read_csv("./demo_data/penguins.csv")
penguins
```



## 每个种类有多少企鹅

统计每个种类企鹅的数量，然后画出来。

按照常规的思路，我们一般会先统计，然后喂给`ggplot()`，
```{r}
penguins %>%
  count(species) %>%
  ggplot(aes(x = species, y = n)) +
  geom_point()
```



这种情形，常用柱状图，因此可以选择`geom_col()`这种几何形状

```{r}
penguins %>%
  count(species) %>%
  ggplot(aes(x = species, y = n)) +
  geom_col()
```


是好图吗？如果不是，怎么改进？

- 排序 
```{r}
penguins %>%
  count(species) %>%
  ggplot(aes(x = fct_reorder(species, n), y = n)) +
  geom_col(width = 0.5)
```

- 翻转 
```{r}
penguins %>%
  count(species) %>%
  ggplot(aes(y = fct_reorder(species, n), x = n)) +
  geom_col(width = 0.5)
```


- 配色

```{r}
penguins %>%
  count(species) %>%
  ggplot(aes(x = fct_reorder(species, n), y = n, fill = species)) +
  geom_col(width = 0.5)
```

```{block}
色彩是一种很强的刺激（信息），一般会有三种作用：分组，强调，量化。如果你的图不想表达这三种意思，那图中尽可能的不要用太多色彩
```


**课堂练习**：用单独一个颜色高亮`Gentoo`那根柱子，其他两个柱子用灰色

> 思路1， 用设置的方法

```{r}
penguins %>%
  count(species) %>%
  ggplot(aes(x = species, y = n)) +
  geom_col(width = 0.5, fill = c("gray", "orange", "gray"))
```

> 思路2：前面提到aes(fill = species)是3种species对应3种颜色，那么我们能否构建一个新变量is_Gentoo，它只包含(是Gentoo、不是Gentoo)，正好对应两种颜色（高亮色、灰色）

```{r}
penguins %>%
  count(species) %>%
  mutate(is_Gentoo = if_else(species == "Gentoo", "yes", "no")) %>%
  ggplot(aes(x = fct_reorder(species, n), y = n, fill = is_Gentoo)) +
  geom_col(width = 0.5) +
  theme_classic()
```

问题来了，怎么修改颜色？下节课讲scales。


## 每个种类嘴峰长度的均值

先求出不同种类企鹅嘴峰长度的均值，然后画图

```{r}
penguins %>%
  group_by(species) %>%
  summarise(
    mean = mean(bill_length_mm)
  ) %>%
  ggplot(aes(x = species, y = mean)) +
  geom_col(width = 0.5)
```


同一个物种下再分性别，即同一个物种下有两根柱子
```{r}
penguins %>%
  group_by(species, sex) %>%
  summarise(
    mean = mean(bill_length_mm)
  ) %>%
  ggplot(aes(x = species, y = mean, fill = sex)) +
  geom_col(width = 0.5, position = position_dodge(0.6))
```






## 嘴峰长度的分布

### 直方图
嘴峰长度是连续变量，可以用直方图
```{r}
penguins %>%
  ggplot(aes(x = bill_length_mm)) +
  geom_histogram()
```

### 密度图
或者密度图
```{r}
penguins %>%
  ggplot(aes(x = bill_length_mm)) +
  geom_density()
```


为什么是两个峰？如何探究背后的原因？种类不同导致的？性别不同导致的？还是所在岛屿不同导致的？

```{r}
penguins %>%
  ggplot(aes(x = bill_length_mm, color = species)) +
  geom_density()
```


```{r}
penguins %>%
  filter(species == "Gentoo") %>%
  ggplot(aes(x = bill_length_mm, color = sex)) +
  geom_density()
```

对于Adelie类而言，是不是也存在类似结构？



### dot plot

直方图的另外一种版本
```{r}
penguins %>%
  ggplot(aes(x = bill_length_mm, fill = species)) +
  geom_dotplot(binwidth = .5)
```


```{r}
penguins %>%
  ggplot(aes(x = species, y = bill_length_mm)) +
  geom_dotplot(
    binaxis  = "y",
    stackdir = "down",
    dotsize  = 0.4,
    position = position_nudge(-0.025)
  )
```


## 不同种类，嘴峰长度分布

这里一个是离散变量，一个是连续变量。可以选择不同的几何形状来呈现


### 散点图
```{r}
penguins %>%
  ggplot(aes(x = species, y = bill_length_mm)) +
  geom_point()
```



### 抖散图
点重叠的处理方案

```{r}
penguins %>%
  ggplot(aes(x = species, y = bill_length_mm)) +
  geom_jitter()
```


```{r}
penguins %>%
  ggplot(aes(x = species, y = bill_length_mm, color = species)) +
  geom_point(
    position = position_jitter(width = 0.3, height = 0.06),
    alpha = 0.9,
    shape = 21,
    size = 3
  )
```

### 箱线图
可以用箱线图（箱线图可以显示分布的中位数、分位数等）

```{r}
penguins %>%
  ggplot(aes(x = species, y = bill_length_mm)) +
  geom_boxplot() +
  geom_jitter()
```

```{r}
penguins %>%
  ggplot(aes(
    x = fct_reorder(species, bill_length_mm, median),
    y = bill_length_mm
  )) +
  geom_boxplot() +
  geom_jitter()
```



### 小提琴图
```{r}
penguins %>%
  ggplot(aes(x = species, y = bill_length_mm)) +
  geom_violin(fill = "grey90") +
  geom_jitter()
```

```{r}
penguins %>%
  ggplot(aes(x = species, y = bill_length_mm)) +
  geom_violin() +
  geom_boxplot(width = .1, fill = "black", outlier.colour = NA) +
  stat_summary(fun = median, geom = "point", fill = "red", shape = 21, size = 4)
```





### 山峦图
```{r}
library(ggridges)
penguins %>%
  ggplot(aes(y = species, x = bill_length_mm, fill = species)) +
  ggridges::geom_density_ridges(alpha = 0.5)
```


### 各种组合

```{r}
library(see)
penguins %>%
  ggplot(aes(x = species, y = bill_length_mm, fill = species)) +
  geom_violinhalf() +
  geom_dotplot(
    binaxis = "y", stackdir = "down",
    dotsize = .4, position = position_nudge(-0.025)
  ) +
  theme_modern() +
  stat_summary(
    fun.data = mean_sdl,
    fun.args = list(mult = 1),
    geom = "pointrange",
    position = position_nudge(0.05)
  ) +
  scale_fill_manual(values = c("#9fb69b", "#f7cfad", "#e8867c")) +
  labs(y = "bill length (mm)")
```



## 嘴峰长度和嘴峰厚度之间的关系

两个连续变量，最常用的是散点图

```{r}
penguins %>%
  ggplot(aes(x = bill_length_mm, y = bill_depth_mm)) +
  geom_point()
```

```{r}
penguins %>%
  ggplot(aes(x = bill_length_mm, y = bill_depth_mm)) +
  geom_point(
    aes(color = species, fill = species),
    shape = 21,
    alpha = .5,
    size = 4
  )
```

## 增加拟合回归线

### 多项式回归
```{r}
penguins %>%
  ggplot(aes(x = bill_length_mm, y = bill_depth_mm)) +
  geom_point() +
  stat_smooth(method = loess, method.args = list(degree = 1))
```



### 线性回归
```{r}
penguins %>%
  ggplot(aes(x = bill_length_mm, y = bill_depth_mm, color = species)) +
  geom_point() +
  stat_smooth(method = lm, se = FALSE)
```



### 逻辑回归 
```{r}
penguins %>%
  mutate(sex = if_else(sex == "male", 1, 0)) %>%
  ggplot(aes(x = bill_length_mm, y = sex)) +
  geom_point(
    position = position_jitter(width = 0.3, height = 0.06),
    alpha = 0.4,
    shape = 21,
    size = 1.5
  ) +
  stat_smooth(method = glm, method.args = list(family = binomial))
```

## 二维密度分布图

`stat_density2d()`是二维版本的`stat_density()`

```{r}
penguins %>%
  ggplot(aes(x = bill_length_mm, y = bill_depth_mm)) +
  geom_point() +
  stat_density2d()
```


```{r}
# Contour lines, with "height" mapped to color
penguins %>%
  ggplot(aes(x = bill_length_mm, y = bill_depth_mm)) +
  geom_point() +
  stat_density2d(aes(colour = stat(level)))
```


我更推荐使用`ggdensity`的方案

```{r, fig.asp = 0.6, fig.width=8}
library(ggdensity) # remotes::install_github("jamesotto852/ggdensity")

penguins %>%
  ggplot(aes(flipper_length_mm, bill_length_mm, fill = species)) +
  ggdensity::geom_hdr(xlim = c(160, 240), ylim = c(30, 70)) +
  geom_point(shape = 21)
```

## 马赛克图
```{r}
penguins %>% 
  select(sex, species, flipper_length_mm) %>% 
  mutate(interval = cut(flipper_length_mm, breaks = 8)) %>% 
  count(sex, interval) %>% 
  
  ggplot(aes(y = sex, x = interval, fill = n)) +
  geom_tile(width = 0.95, height = 0.95, colour = "white") +
  geom_text(aes(label = n), color = "white") +
  #scale_x_discrete(name = NULL, expand = c(0, 0)) +
  #scale_y_discrete(name = NULL, expand = c(0, 0)) +
  coord_fixed(expand = FALSE) +
  ggtitle("Palmer's Penguins' dataset")
```

## 分组

ggplot2实现分组的方法很多，通常情况下，是把一个**离散变量**映射到以下**图形属性**

- `group`
- `color`
- `fill`
- `alpha`
- `shape`
- `size`
- `linetype`



```{r}
penguins %>%
  ggplot(aes(x = bill_length_mm, y = bill_depth_mm)) +
  geom_point(aes(color = species))
```



```{r}
penguins %>%
  ggplot(aes(x = bill_length_mm, y = bill_depth_mm)) +
  geom_point(aes(shape = species))
```


```{r}
penguins %>%
  ggplot(aes(x = bill_length_mm, y = bill_depth_mm)) +
  geom_point(aes(alpha = species))
```


还有一种分组方法，就是**分面**
```{r}
penguins %>%
  ggplot(aes(x = bill_length_mm, y = bill_depth_mm)) +
  geom_point() +
  facet_wrap(vars(species))
```



**课堂练习**：用分面画出，不同种类企鹅bill_length_mm的密度分布图

```{r}
penguins %>%
  ggplot(aes(x = bill_length_mm, color = species)) +
  geom_density() +
  facet_wrap(vars(species))
```



散点图的分面，还可以弄得更漂亮点吗？

```{r}
penguins %>%
  ggplot(aes(x = bill_length_mm, y = bill_depth_mm)) +
  geom_point(data = penguins %>% select(-species), color = "gray80") +
  geom_point(aes(color = species)) +
  facet_wrap(vars(species), ncol = 3)
```






## 图层叠加

以下是不同性别的企鹅体重，希望在图中显示出**均值的位置**
```{r}
penguins %>%
  ggplot(aes(x = sex, y = body_mass_g)) +
  geom_jitter()
```


```{r}
m <- penguins %>%
  group_by(sex) %>%
  summarise(
    mean = mean(body_mass_g)
  )
m
```

也可以画出均值的位置
```{r}
ggplot(data = m, aes(x = sex, y = mean)) +
  geom_point(color = "red", size = 5)
```

现在我们把这两个图叠加在一起，**注意这张图的继承关系**，包括`data =` 以及 `aes()` 的继承，具体说：

- 第一个图用的数据是什么，映射关系是什么？
`data = penguins,   x = sex,  y = body_mass_g` 

- 第二个图用的数据是什么，映射关系是什么？
`data = m,          x = sex,  y = mean`


因此，两个数据框合在一起画图的代码

```{r}
ggplot() +
  geom_jitter(data = penguins, aes(x = sex, y = body_mass_g)) +
  geom_point(data = m, aes(x = sex, y = mean), color = "red", size = 5)
```


最终可以简化成下面的形式

```{r}
penguins %>%
  ggplot(aes(x = sex, y = body_mass_g)) +
  geom_jitter() +
  geom_point(data = m, aes(y = mean), color = "red", size = 5)
```




## 添加文本标签

如何在点的位置**添加**具体数值文本？

```{r}
penguins %>%
  ggplot(aes(x = sex, y = body_mass_g)) +
  geom_jitter() +
  geom_point(
    data = m, aes(y = mean), size = 5, color = "red"
  ) +
  geom_text(
    data = m,
    aes(x = sex, y = mean, label = round(mean, 2)), size = 5,
    color = "red", vjust = -1
  )
```



有时候我们需要添加文本注解，
```{r}
mean_length <- penguins %>%
  summarise(
    mean = mean(bill_length_mm)
  ) %>%
  pull(mean)

arrows <-
  tibble(
    x1 = 38,
    y1 = 2.6,
    x2 = mean_length,
    y2 = 2.6
  )

penguins %>%
  group_by(species) %>%
  mutate(mean_length_species = mean(bill_length_mm)) %>%
  ggplot(aes(x = bill_length_mm, y = species, color = species)) +
  geom_vline(aes(xintercept = mean_length), color = "gray70", size = 1.2) +
  geom_segment(
    aes(
      y = species, yend = species,
      x = mean_length, xend = mean_length_species
    ),
    size = 0.8
  ) +
  geom_curve(
    data = arrows, aes(x = x1, y = y1, xend = x2, yend = y2),
    arrow = arrow(length = unit(0.07, "inch")), size = 0.8,
    color = "gray20", curvature = -0.3
  ) +
  stat_summary(fun = mean, geom = "point", size = 5) +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  annotate(
    "text",
    x = 38, y = 2.5, size = 5, color = "gray20",
    label = "All penguins average"
  ) +
  theme(
    legend.position = "none",
    panel.grid = element_blank()
  )
```

## 云雨图

```{r}
library(ggdist)

penguins %>%
  ggplot(aes(y = species, x = bill_length_mm, fill = species)) +
  stat_slab(aes(thickness = stat(pdf*n)), scale = 0.7) +
  stat_dotsinterval(side = "bottom", scale = 0.7, slab_size = NA) +
  scale_fill_brewer(palette = "Set2") +
  ggtitle("This is rain cloud plot!")
```


## 椭圆图

```{r}
penguins %>%
  ggplot(aes(x = bill_length_mm, y = bill_depth_mm)) +
  geom_point() +
  geom_path(stat = "ellipse")
```

每个物种想有各自的椭圆图？
```{r}
penguins %>%
  ggplot(aes(x = bill_length_mm, y = bill_depth_mm, color = species)) +
  geom_point() +
  geom_path(stat = "ellipse")
```

```{r}
library(geomtextpath) 

penguins %>%
  ggplot(aes(x = bill_length_mm, y = bill_depth_mm, color = species)) +
  geom_point() +
  geom_textpath(aes(label = species), stat = "ellipse", size = 5, hjust = 1) + 
  theme(legend.position = "none")
```

## 函数图

```{r}
ggplot() +
  geom_function(fun = dnorm, args = list(mean = 0, sd = 0.5)) +
  xlim(-2, 2)
```



```{r}
f <- function(x) 0.5 * exp(-abs(x))


ggplot() +
  geom_function(fun = f, colour = "red") +
  xlim(-5, 5)
```

**课堂练习**：自己定义一个函数，然后画出来



## 地图

```{r}
library(rnaturalearth) # install.packages("rnaturalearth")

world_map_data <- ne_countries(scale = "medium", returnclass = "sf")

ggplot(data = world_map_data) +
  geom_sf(fill = "antiquewhite1") +
  theme(panel.background = element_rect(fill = "aliceblue"))
```

```{r}
# 读取四川县界地图

library(sf)
sichuan <- st_read("./mapdata/sichuan_xianjie.shp")

ggplot(sichuan) + 
  geom_sf() 
```

四川火锅最辣的地方
```{r}
hotpot <- tibble::tribble(
  ~NAME,    ~taste,
  "乐山市",  "hot",
  "仁寿县",  "hot",
  "内江市",  "hot",
  "青川县",  "hot",
  "红原县",  "hot"
  )

hotpot
```

```{r}
sichuan %>%
  left_join(hotpot, by = "NAME") %>%
  mutate(
    taste = replace_na(taste, "not very hot")
  ) %>%
  ggplot() +
  geom_sf(aes(fill = taste)) +
  scale_fill_manual(
    values = c("hot" = "#fc9272", "not very hot" = "gray80")
  ) +
  geom_sf_text(
    data = ~ filter(., taste == "hot"),
    aes(label = NAME),
    size = 3
  ) +
  theme(
    legend.position = "none"
  )
```



# 总结

- `geom_point()`
- `geom_smooth`
- `geom_col()`
- `geom_histogram()`
- `geom_density()`
- `geom_jitter()`
- `geom_boxplot()`
- `geom_violin()`
- `geom_text()`
- `ggridges::geom_density_ridges()`
- `geom_path()`
- `geom_segment()`
- `geom_function()`
- `geom_sf()`
- `facet_wrap()`
- `forcats::fct_reorder()`



